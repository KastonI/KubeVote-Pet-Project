name: Secrets and config security scan

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

env:
  TRIVY_SEVERITY: "CRITICAL,HIGH"

jobs:
  security-scan:
    name: Secrets scan (Gitleaks SARIF)
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks secrets scan
        continue-on-error: true
        uses: gitleaks/gitleaks-action@v2

      - name: Upload SARIF (secrets)
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif
          category: gitleaks/fs/secrets

  misconfig-scan:
    name: Dependencies + misconfig (SARIF)
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trivy vuln & misconfig scan (SARIF)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: fs
          scan-ref: .
          scanners: vuln,misconfig
          ignore-unfixed: true
          severity: CRITICAL
          format: sarif
          output: trivy-vuln-misconfig.sarif
          trivyignores: .trivyignore

      - name: Upload SARIF (vuln & misconfig)
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-vuln-misconfig.sarif
          category: trivy/fs/vuln-misconfig

  helm-iac-scan:
    name: Helm
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trivy Helm scan (SARIF, non-blocking)
        if: hashFiles('apps/**/Chart.yaml') != ''
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: config
          scan-ref: apps
          severity: CRITICAL
          exit-code: "0"
          format: sarif
          output: trivy-helm.sarif
          trivyignores: .trivyignore

      - name: Upload SARIF (helm)
        if: always() && hashFiles('apps/**/Chart.yaml') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-helm.sarif
          category: trivy/config/helm

  helm_lint:
    name: Helm lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Helm lint kube-vote
        if: hashFiles('apps/kube-vote/Chart.yaml') != ''
        run: |
          helm lint ./apps/kube-vote \
            --values ./apps/kube-vote/values.yaml \
            --strict

      - name: Helm lint karpenter-nodepool
        if: hashFiles('apps/karpenter-nodepool/Chart.yaml') != ''
        run: |
          helm lint ./apps/karpenter-nodepool\
            --values ./apps/karpenter-nodepool/values.yaml \
            --strict

  terraform-scan:
    name: Terraform security scan
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trivy Terraform scan (SARIF, non-blocking)
        if: hashFiles('terraform/*.tf') != ''
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: config
          scan-ref: .
          severity: CRITICAL
          exit-code: "0"
          format: sarif
          output: trivy-terraform.sarif
          trivyignores: .trivyignore

      - name: Upload SARIF (terraform)
        if: always() && hashFiles('terraform/*.tf') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-terraform.sarif
          category: trivy/config/terraform

      - name: Trivy Terraform gate (table)
        if: hashFiles('terraform/*.tf') != ''
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: config
          scan-ref: .
          severity: CRITICAL
          exit-code: "1"
          format: table
          trivyignores: .trivyignore

  terraform-validate:
    name: Terraform validate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        if: hashFiles('terraform/*.tf') != ''
        uses: hashicorp/setup-terraform@v3

      - name: Terraform init (no backend)
        if: hashFiles('terraform/*.tf') != ''
        working-directory: terraform
        run: terraform init -backend=false

      - name: Terraform validate
        if: hashFiles('terraform/*.tf') != ''
        working-directory: terraform
        run: terraform validate
