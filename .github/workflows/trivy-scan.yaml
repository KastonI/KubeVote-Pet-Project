name: Secrets and config security scan

on:
  pull_request:
    branches: [ "master" ]
  push:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

env:
  TRIVY_SEVERITY: "CRITICAL,HIGH"

jobs:
  security-scan:
    name: Secrets scan (Gitleaks SARIF)
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks secrets scan (SARIF)
        uses: gitleaks/gitleaks-action@v2
        with:
          args: >
            detect
            --source=.
            --report-format=sarif
            --report-path=gitleaks.sarif
            --redact

      - name: Upload SARIF (secrets)
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: gitleaks.sarif
          category: gitleaks/fs/secrets

  misconfig-scan:
    name: Dependencies + misconfig (SARIF)
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trivy vuln & misconfig scan (SARIF)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: fs
          scan-ref: .
          scanners: vuln,misconfig
          ignore-unfixed: true
          severity: CRITICAL
          format: sarif
          output: trivy-vuln-misconfig.sarif
          trivyignores: .trivyignore

      - name: Upload SARIF (vuln & misconfig)
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-vuln-misconfig.sarif
          category: trivy/fs/vuln-misconfig

  helm-iac-scan:
    name: Helm / Kubernetes IaC
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trivy Helm scan (SARIF, non-blocking)
        if: hashFiles('helm/**/Chart.yaml') != ''
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: config
          scan-ref: helm
          severity: CRITICAL
          exit-code: "0"
          format: sarif
          output: trivy-helm.sarif
          trivyignores: .trivyignore

      - name: Upload SARIF (helm)
        if: always() && hashFiles('helm/**/Chart.yaml') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-helm.sarif
          category: trivy/config/helm

      - name: Trivy Helm gate (table)
        if: hashFiles('helm/**/Chart.yaml') != ''
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: config
          scan-ref: helm
          severity: CRITICAL
          exit-code: "1"
          format: table
          trivyignores: .trivyignore

      # ---------------------------------
      # Terraform security scan
      # Аналогично: SARIF всегда загрузить + gate валит на CRITICAL с читабельным логом
      # ---------------------------------
  terraform-scan:
    name: Terraform security scan
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trivy Terraform scan (SARIF, non-blocking)
        if: hashFiles('**/*.tf') != ''
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: config
          scan-ref: .
          severity: CRITICAL
          exit-code: "0"
          format: sarif
          output: trivy-terraform.sarif
          trivyignores: .trivyignore

      - name: Upload SARIF (terraform)
        if: always() && hashFiles('**/*.tf') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-terraform.sarif
          category: trivy/config/terraform

      - name: Trivy Terraform gate (table)
        if: hashFiles('**/*.tf') != ''
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: config
          scan-ref: .
          severity: CRITICAL
          exit-code: "1"
          format: table
          trivyignores: .trivyignore

      # -----------------------
      # Terraform validate
      # -----------------------
  terraform-validate:
    name: Terraform validate
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        if: hashFiles('infra/terraform/**/*.tf') != ''
        uses: hashicorp/setup-terraform@v3

      - name: Terraform init (no backend)
        if: hashFiles('infra/terraform/**/*.tf') != ''
        working-directory: infra/terraform
        run: terraform init -backend=false

      - name: Terraform validate
        if: hashFiles('infra/terraform/**/*.tf') != ''
        working-directory: infra/terraform
        run: terraform validate
